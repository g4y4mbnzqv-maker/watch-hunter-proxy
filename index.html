<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vintage Watch Deal Hunter</title>
<link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: linear-gradient(150deg, #f5f0e6 0%, #ede8db 100%); min-height: 100vh; font-family: 'DM Mono', monospace; padding: 32px 16px; }
  .container { max-width: 560px; margin: 0 auto; animation: fadeUp 0.5s ease; }
  @keyframes fadeUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes urgentPulse { 0%,100% { opacity:1; } 50% { opacity:0.55; } }
  @keyframes shimmerIn { from { opacity:0; transform:translateY(4px); } to { opacity:1; transform:translateY(0); } }

h1 { font-family: â€˜Loraâ€™, serif; font-size: 32px; font-weight: 700; color: #1c1410; line-height: 1.08; letter-spacing: -0.5px; }
h1 span { color: #d97706; }
.subtitle { margin-top: 6px; font-size: 11px; color: #b8a898; }

.status-dot { width:7px; height:7px; border-radius:50%; display:inline-block; transition:all 0.3s; }
.status-dot.loading { background:#d97706; box-shadow:0 0 0 3px #fef3c7; }
.status-dot.live { background:#16a34a; box-shadow:0 0 0 3px #dcfce7; }
.status-dot.fallback { background:#d97706; box-shadow:0 0 0 3px #fef3c7; }

.status-bar { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
.status-text { font-size:10px; color:#b8a898; letter-spacing:2px; text-transform:uppercase; }
.status-time { font-size:9px; color:#c8bfb0; margin-left:auto; }

.banner { margin-bottom:14px; padding:8px 14px; border-radius:10px; font-size:10px; font-family:monospace; }
.banner.live { background:#f0fdf4; border:1px solid #bbf7d0; color:#166534; }
.banner.fallback { background:#fffbeb; border:1px solid #fde68a; color:#92400e; }
.banner.error { background:#fef2f2; border:1px solid #fecaca; color:#991b1b; }
.banner.notif-granted { background:#f0fdf4; border:1px solid #bbf7d0; color:#166534; display:flex; align-items:center; gap:6px; }
.banner.notif-denied { background:#fef2f2; border:1px solid #fecaca; color:#991b1b; }

.notif-banner { background:#fff; border:1px solid #e8e2d8; border-radius:12px; padding:12px 14px; display:flex; align-items:center; gap:10px; margin-bottom:14px; box-shadow:0 1px 4px rgba(0,0,0,0.04); }
.notif-banner .notif-text h4 { font-family:â€˜Loraâ€™,serif; font-size:11px; color:#2c2416; font-weight:600; }
.notif-banner .notif-text p { font-size:10px; color:#b8a898; margin-top:2px; }
.notif-banner button { padding:6px 14px; background:#d97706; color:#fff; border:none; border-radius:8px; font-size:10px; cursor:pointer; font-family:monospace; white-space:nowrap; }

.tabs { display:flex; gap:6px; margin-bottom:14px; }
.tab { flex:1; padding:9px 4px; border-radius:10px; font-size:10px; cursor:pointer; transition:all 0.18s; font-family:monospace; border:1px solid #ddd5c8; background:transparent; color:#b8a898; }
.tab.active { background:#fff; border:1.5px solid #d97706; color:#b45309; box-shadow:0 2px 10px rgba(217,119,6,0.1); }

.controls { display:flex; gap:8px; margin-bottom:14px; flex-wrap:wrap; align-items:center; }
.pill { display:flex; align-items:center; gap:6px; padding:8px 14px; border-radius:20px; cursor:pointer; font-size:10px; font-family:monospace; transition:all 0.18s; border:1px solid #ddd5c8; background:#fff; color:#b8a898; }
.pill.active { background:#fffbeb; border-color:#f59e0b; color:#b45309; box-shadow:0 2px 10px rgba(245,158,11,0.15); }
.pill.price-active { background:#fffbeb; border-color:#d97706; color:#b45309; }
.pill .badge { background:#f59e0b; color:#fff; border-radius:10px; font-size:9px; padding:1px 6px; font-weight:700; }
.refresh-btn { margin-left:auto; padding:8px 12px; background:#fff; border:1px solid #ddd5c8; border-radius:20px; cursor:pointer; color:#b8a898; font-size:12px; transition:all 0.18s; }
.refresh-btn:hover { color:#d97706; border-color:#d97706; }

.slider-wrap { margin-bottom:14px; padding:14px 16px; background:#fff; border-radius:12px; border:1px solid #e8e2d8; box-shadow:0 1px 4px rgba(0,0,0,0.04); animation:shimmerIn 0.2s ease; }
.slider-header { display:flex; justify-content:space-between; margin-bottom:10px; }
.slider-label { font-size:10px; color:#b8a898; letter-spacing:1px; }
.slider-val { font-family:â€˜Loraâ€™,serif; font-size:14px; font-weight:700; color:#d97706; }
input[type=range] { -webkit-appearance:none; width:100%; height:4px; outline:none; cursor:pointer; border-radius:2px; }
input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:18px; height:18px; border-radius:50%; background:#d97706; cursor:pointer; box-shadow:0 1px 6px rgba(217,119,6,0.35); }
.slider-limits { display:flex; justify-content:space-between; margin-top:5px; font-size:9px; color:#c8bfb0; }

.countdown-wrap { margin-bottom:16px; }
.countdown-header { display:flex; justify-content:space-between; margin-bottom:5px; }
.countdown-label { font-size:10px; color:#b8a898; letter-spacing:1px; }
.countdown-time { font-size:10px; color:#d97706; }
.countdown-track { height:3px; background:#ede8de; border-radius:2px; overflow:hidden; }
.countdown-fill { height:100%; background:linear-gradient(90deg,#d97706,#fbbf24); border-radius:2px; transition:width 1s linear; }

.stats { display:flex; margin-bottom:14px; background:#fff; border-radius:12px; border:1px solid #e8e2d8; overflow:hidden; box-shadow:0 1px 4px rgba(0,0,0,0.04); animation:shimmerIn 0.3s ease; }
.stat { flex:1; padding:12px 8px; text-align:center; border-right:1px solid #f0ebe0; }
.stat:last-child { border-right:none; }
.stat-val { font-family:â€˜Loraâ€™,serif; font-size:19px; font-weight:700; }
.stat-lbl { font-size:9px; color:#c8bfb0; letter-spacing:1px; margin-top:2px; }

.ai-box { margin-bottom:14px; padding:14px 16px; background:#fffbeb; border:1px solid #fde68a; border-radius:12px; animation:shimmerIn 0.4s ease; }
.ai-label { font-size:9px; color:#b45309; letter-spacing:2px; margin-bottom:6px; }
.ai-text { font-family:â€˜Loraâ€™,serif; font-size:13px; color:#78350f; line-height:1.65; font-style:italic; }
.ai-loading { display:flex; gap:8px; align-items:center; }
.ai-spinner { width:12px; height:12px; border:2px solid #fde68a; border-top-color:#d97706; border-radius:50%; animation:spin 0.8s linear infinite; }
.ai-loading-text { font-size:11px; color:#b45309; }

.alert-log { margin-bottom:14px; }
.alert-log-label { font-size:9px; color:#b8a898; letter-spacing:2px; margin-bottom:6px; }
.alert-item { padding:8px 12px; border-radius:8px; font-size:10px; font-family:monospace; display:flex; align-items:center; gap:8px; margin-bottom:5px; }
.alert-item.hot { background:#fffbeb; border:1px solid #fde68a; color:#92400e; }
.alert-item.snipe { background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; }
.alert-title { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.alert-price { font-weight:700; }
.alert-time { color:#c8bfb0; }

.listings { display:flex; flex-direction:column; gap:8px; }
.skeleton { height:95px; background:#fff; border-radius:14px; border:1px solid #e8e2d8; }

.card { display:block; text-decoration:none; background:#fff; border:1px solid #e8e2d8; border-radius:14px; padding:14px 16px; transition:all 0.18s ease; cursor:pointer; box-shadow:0 1px 3px rgba(0,0,0,0.04); animation:shimmerIn 0.25s ease both; }
.card:hover { background:#f8f4ee; transform:translateY(-2px); box-shadow:0 6px 24px rgba(0,0,0,0.07); }
.card.hot { border:1.5px solid #d97706; box-shadow:0 2px 10px rgba(217,119,6,0.1); }
.card.urgent { background:#fffbeb; border:1.5px solid #f59e0b; }
.card-inner { display:flex; align-items:flex-start; gap:12px; }
.card-rank { font-family:monospace; font-size:11px; color:#c8bfb0; min-width:20px; padding-top:2px; }
.card-body { flex:1; min-width:0; }
.card-badges { display:flex; gap:5px; flex-wrap:wrap; margin-bottom:6px; }
.badge { font-size:9px; font-weight:700; padding:2px 6px; border-radius:4px; font-family:monospace; white-space:nowrap; }
.badge.hot-buy { background:#92400e; color:#fef3c7; letter-spacing:1px; }
.badge.snipe-now { background:#fef2f2; color:#dc2626; animation:urgentPulse 1s infinite; }
.badge.ending-soon { background:#fff7ed; color:#ea580c; }
.badge.steal { background:#fef3c7; color:#92400e; }
.badge.great { background:#d1fae5; color:#065f46; }
.badge.good { background:#dbeafe; color:#1e40af; }
.card-title { font-family:â€˜Loraâ€™,serif; font-size:13.5px; color:#2c2416; line-height:1.45; margin-bottom:8px; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; }
.card-prices { display:flex; gap:8px; align-items:baseline; flex-wrap:wrap; }
.card-price { font-family:monospace; font-size:17px; font-weight:700; color:#1c1410; }
.card-price.hot { color:#b45309; }
.card-mktval { font-size:11px; color:#b8a898; font-family:monospace; display:flex; align-items:center; gap:4px; }
.card-sep { font-size:11px; color:#c8bfb0; font-family:monospace; }
.card-bids { font-size:11px; color:#b8a898; font-family:monospace; }
.card-time { font-size:11px; font-family:monospace; margin-left:auto; color:#b8a898; }
.card-time.urgent { color:#dc2626; font-weight:700; }
.card-source { margin-top:5px; font-size:9px; color:#c8bfb0; font-family:monospace; }
.card-arrow { color:#ddd8d0; font-size:16px; transition:all 0.18s; }
.card:hover .card-arrow { color:#d97706; transform:translateX(3px); }
.mv-spinner { width:8px; height:8px; border:1.5px solid #e0d8cc; border-top-color:#d97706; border-radius:50%; display:inline-block; animation:spin 0.7s linear infinite; }

.empty { padding:36px; text-align:center; background:#fff; border-radius:14px; border:1px solid #e8e2d8; }
.empty-icon { font-size:30px; margin-bottom:10px; }
.empty p { font-size:12px; color:#b8a898; }
.empty small { font-size:10px; color:#c8bfb0; margin-top:4px; display:block; }

.footer { margin-top:22px; text-align:center; }
.cta { display:inline-block; padding:12px 30px; background:#d97706; border-radius:12px; color:#fff; font-size:11px; letter-spacing:1.5px; text-decoration:none; font-family:monospace; font-weight:500; transition:all 0.18s; box-shadow:0 4px 16px rgba(217,119,6,0.28); }
.cta:hover { background:#b45309; transform:translateY(-1px); }
.footer-note { margin-top:10px; font-size:9px; color:#c8bfb0; }
</style>

</head>
<body>
<div class="container">

  <!-- Header -->

  <div style="margin-bottom:24px">
    <div class="status-bar">
      <span class="status-dot" id="statusDot"></span>
      <span class="status-text" id="statusText">loadingâ€¦</span>
      <span class="status-time" id="statusTime"></span>
    </div>
    <h1>Vintage Watch<br><span>Deal Hunter</span></h1>
    <p class="subtitle">UK-only auctions Â· live market values via web search</p>
  </div>

  <!-- Banners -->

  <div id="apiBanner"></div>
  <div id="notifBanner"></div>
  <div id="alertLog"></div>

  <!-- Tabs -->

  <div class="tabs">
    <button class="tab active" onclick="switchTab(0)">â—ˆ Seiko Vintage</button>
    <button class="tab" onclick="switchTab(1)">â—‰ Japanese Vintage</button>
    <button class="tab" onclick="switchTab(2)">â— All Vintage</button>
  </div>

  <!-- Controls -->

  <div class="controls">
    <button class="pill" id="snipeBtn" onclick="toggleSnipe()">âš¡ Snipe mode OFF</button>
    <button class="pill" id="priceBtn" onclick="togglePrice()">Â£ Price cap</button>
    <button class="refresh-btn" onclick="doFetch()">â†»</button>
  </div>

  <!-- Price slider -->

  <div class="slider-wrap" id="sliderWrap" style="display:none">
    <div class="slider-header">
      <span class="slider-label">PRICE CEILING</span>
      <span class="slider-val" id="sliderVal">Â£150</span>
    </div>
    <input type="range" id="priceSlider" min="5" max="500" step="5" value="150" oninput="updateSlider(this.value)" onchange="doFetch()">
    <div class="slider-limits"><span>Â£5</span><span>Â£500</span></div>
  </div>

  <!-- Countdown -->

  <div class="countdown-wrap">
    <div class="countdown-header">
      <span class="countdown-label">AUTO-REFRESH</span>
      <span class="countdown-time" id="countdownTime">5:00</span>
    </div>
    <div class="countdown-track"><div class="countdown-fill" id="countdownFill" style="width:100%"></div></div>
  </div>

  <!-- Stats -->

  <div class="stats" id="stats" style="display:none">
    <div class="stat"><div class="stat-val" id="statCount" style="color:#1c1410">0</div><div class="stat-lbl">AUCTIONS</div></div>
    <div class="stat"><div class="stat-val" id="statHot" style="color:#d97706">0</div><div class="stat-lbl">HOT BUYS</div></div>
    <div class="stat"><div class="stat-val" id="statLowest" style="color:#16a34a">â€”</div><div class="stat-lbl">LOWEST BID</div></div>
  </div>

  <!-- AI Summary -->

  <div class="ai-box" id="aiBox" style="display:none">
    <div class="ai-label">â—ˆ EXPERT ANALYSIS</div>
    <div id="aiContent"></div>
  </div>

  <!-- Listings -->

  <div class="listings" id="listings"></div>

  <!-- Footer -->

  <div class="footer" id="footer" style="display:none">
    <a class="cta" id="ctaLink" href="#" target="_blank">VIEW ALL ON EBAY.CO.UK â†’</a>
    <p class="footer-note">Live eBay UK data Â· market values sourced via web search Â· click any card to view on eBay</p>
  </div>

</div>

<script>
const PROXY_URL = "https://watch-hunter-proxy.vercel.app/api/ebay";
const REFRESH_INTERVAL = 300;
const SEARCHES = [
  { label: "Seiko Vintage", query: "seiko vintage watch" },
  { label: "Japanese Vintage", query: "japan vintage watch automatic" },
  { label: "All Vintage", query: "vintage watch auction" },
];
const VALUE_SIGNALS = ["no reserve","nr","starting bid","0.99","1 bid","0 bids","estate","collection","lot","bundle","untested","as-is","job lot","spares"];
const MARKET_VALUES_CACHE = {};

let activeTab = 0, snipeMode = false, priceEnabled = false, maxPrice = 150;
let countdown = REFRESH_INTERVAL, countdownTimer = null;
let currentAuctions = [], currentMV = {};
let seenHotBuys = new Set(), seenSnipeAlerts = new Set();
let alertLog = [];

// â”€â”€ Scoring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scoreWatch(title, price, bids, mv) {
  let s = 0, l = title.toLowerCase();
  VALUE_SIGNALS.forEach(sig => { if (l.includes(sig)) s += 2; });
  if (bids < 3) s += 3;
  if (price < 100) s += 2;
  if (price < 50) s += 2;
  if (mv) { if (price < mv*0.3) s += 4; else if (price < mv*0.5) s += 2; }
  if (l.includes("seiko")||l.includes("citizen")||l.includes("orient")) s += 1;
  if (l.includes("omega")||l.includes("longines")) s += 3;
  return s;
}

function parseMins(t) {
  const h = t.match(/(\d+)h/), m = t.match(/(\d+)m/);
  return (h?parseInt(h[1])*60:0) + (m?parseInt(m[1]):0);
}

function extractModel(title) {
  const l = title.toLowerCase();
  const brand = ["seiko","citizen","orient","omega","longines","tissot","bulova"].find(b=>l.includes(b))||"";
  const num = title.match(/\b([0-9]{4,6}|[A-Z]{2,4}[0-9]{3,5})\b/)?.[0]||"";
  const names = ["lord marvel","pogue","monster","seamaster","ultra chron","homer","5 automatic","star","diver"];
  const name = names.find(n=>l.includes(n))||"";
  return [brand, num||name].filter(Boolean).join(" ").trim() || title.split(" ").slice(0,3).join(" ");
}

// â”€â”€ eBay fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchListings(query, cap) {
  const p = new URLSearchParams({ query });
  if (cap) p.set("maxPrice", cap);
  const res = await fetch(`${PROXY_URL}?${p}`);
  if (!res.ok) throw new Error(`Proxy error ${res.status}`);
  const data = await res.json();
  if (data.error) throw new Error(data.error);
  const items = data.itemSummaries || [];
  return items.map(item => {
    const price = parseFloat(item.price?.value || item.currentBidPrice?.value || 0);
    const bids = item.bidCount || 0;
    let timeLeft = "unknown";
    if (item.itemEndDate) {
      const ms = new Date(item.itemEndDate) - Date.now();
      if (ms > 0) { const tm=Math.floor(ms/60000); timeLeft=`${Math.floor(tm/60)}h ${tm%60}m`; } else timeLeft="ended";
    }
    return { id: item.itemId, title: item.title||"Unknown", price, bids, timeLeft, image: item.image?.imageUrl||null, url: item.itemWebUrl||`https://www.ebay.co.uk/sch/i.html?_nkw=${encodeURIComponent(query)}&LH_Auction=1&LH_PrefLoc=1` };
  }).filter(a => a.timeLeft !== "ended" && a.price > 0);
}

// â”€â”€ Market value via Claude â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchMarketValue(title) {
  const model = extractModel(title);
  const key = model.toLowerCase();
  if (MARKET_VALUES_CACHE[key]) return MARKET_VALUES_CACHE[key];
  try {
    const res = await fetch("https://api.anthropic.com/v1/messages", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({
        model:"claude-sonnet-4-20250514", max_tokens:500,
        tools:[{type:"web_search_20250305",name:"web_search"}],
        system:`You are a vintage watch pricing expert. Search eBay UK completed listings for the watch model and return ONLY valid JSON: {"value":<number>,"source":"<brief>","confidence":"<low|medium|high>"}. No markdown.`,
        messages:[{role:"user",content:`eBay UK market value in GBP for: ${model}`}]
      })
    });
    const data = await res.json();
    const text = (data?.content||[]).filter(b=>b.type==="text").map(b=>b.text).join("\n");
    const match = text.match(/\{[\s\S]*?"value"[\s\S]*?\}/);
    if (match) {
      const parsed = JSON.parse(match[0]);
      const result = { value: Math.round(parsed.value), source: parsed.source||"eBay UK sold listings", confidence: parsed.confidence||"medium" };
      MARKET_VALUES_CACHE[key] = result;
      return result;
    }
  } catch(e) { console.warn("MV fetch failed", e); }
  return null;
}

// â”€â”€ Notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initNotifications() {
  const el = document.getElementById("notifBanner");
  if (!("Notification" in window)) return;
  if (Notification.permission === "granted") {
    el.innerHTML = `<div class="banner notif-granted">ğŸ”” Alerts active â€” HOT BUYs &amp; auctions ending within 1 hour</div>`;
  } else if (Notification.permission === "default") {
    el.innerHTML = `<div class="notif-banner"><span style="font-size:18px">ğŸ””</span><div class="notif-text"><h4>Enable deal alerts</h4><p>Get notified for HOT BUYs and auctions ending soon</p></div><button onclick="requestNotif()">Enable</button></div>`;
  } else {
    el.innerHTML = `<div class="banner notif-denied">ğŸ”• Notifications blocked â€” enable in browser settings</div>`;
  }
}

function requestNotif() {
  Notification.requestPermission().then(() => initNotifications());
}

function fireNotif(title, body, tag) {
  if (Notification.permission !== "granted") return;
  try { new Notification(title, { body, tag, icon:"https://www.ebay.co.uk/favicon.ico" }); } catch(e){}
}

function checkNotifications(auctions, mvMap) {
  const now = new Date().toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"});
  auctions.forEach(a => {
    const mv = mvMap[a.id]?.value||null;
    const score = scoreWatch(a.title, a.price, a.bids, mv);
    const mins = parseMins(a.timeLeft);
    const short = a.title.split(" ").slice(0,5).join(" ");
    if (score >= 7 && !seenHotBuys.has(a.id)) {
      seenHotBuys.add(a.id);
      fireNotif("ğŸ”¥ HOT BUY spotted!", `${short}\nÂ£${a.price.toFixed(2)} Â· ${a.timeLeft} left`, `hot-${a.id}`);
      alertLog.unshift({ type:"hot", title:short, price:a.price, time:now });
    }
    if (mins <= 60 && mins > 0 && !seenSnipeAlerts.has(a.id)) {
      seenSnipeAlerts.add(a.id);
      fireNotif("âš¡ Ending soon!", `${short}\nÂ£${a.price.toFixed(2)} Â· ${a.timeLeft} left`, `snipe-${a.id}`);
      alertLog.unshift({ type:"snipe", title:short, price:a.price, timeLeft:a.timeLeft, time:now });
    }
  });
  alertLog = alertLog.slice(0, 8);
  renderAlertLog();
}

function renderAlertLog() {
  if (!alertLog.length) return;
  const el = document.getElementById("alertLog");
  el.innerHTML = `<div class="alert-log"><div class="alert-log-label">RECENT ALERTS</div>${
    alertLog.map(a=>`<div class="alert-item ${a.type}"><span>${a.type==="hot"?"ğŸ”¥":"âš¡"}</span><span class="alert-title">${a.title}</span><span class="alert-price">Â£${a.price.toFixed(2)}</span><span class="alert-time">${a.time}</span></div>`).join("")
  }</div>`;
}

// â”€â”€ Render helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dealBadge(price, mv) {
  if (!mv) return "";
  const pct = Math.round((price/mv)*100), saving = mv-price;
  if (pct > 80 || saving < 5) return "";
  if (pct < 30) return `<span class="badge steal">ğŸ”¥ Steal Â· save ~Â£${saving.toFixed(0)}</span>`;
  if (pct < 50) return `<span class="badge great">âœ“ Great deal Â· save ~Â£${saving.toFixed(0)}</span>`;
  return `<span class="badge good">â†“ Good value Â· save ~Â£${saving.toFixed(0)}</span>`;
}

function snipeBadge(timeLeft) {
  const m = parseMins(timeLeft);
  if (m > 120) return "";
  return m < 60 ? `<span class="badge snipe-now">âš¡ SNIPE NOW</span>` : `<span class="badge ending-soon">â° ENDING SOON</span>`;
}

function confidencePip(c) {
  const colors = {high:"#16a34a",medium:"#d97706",low:"#dc2626"};
  const labels = {high:"âœ“ verified",medium:"~ estimated",low:"? uncertain"};
  return `<span style="font-size:9px;color:${colors[c]||colors.medium};opacity:0.8">${labels[c]||labels.medium}</span>`;
}

function renderCard(a, rank, mv, mvLoading) {
  const score = scoreWatch(a.title, a.price, a.bids, mv?.value||null);
  const isHot = score >= 7;
  const mins = parseMins(a.timeLeft);
  const isUrgent = mins < 60 && mins > 0;
  const classes = ["card", isHot?"hot":"", isUrgent&&snipeMode?"urgent":""].filter(Boolean).join(" ");

  const mvHtml = mvLoading
    ? `<span class="card-mktval"><span class="mv-spinner"></span><span style="color:#c8bfb0">fetching mkt valâ€¦</span></span>`
    : mv
    ? `<span class="card-mktval">est. mkt Â£${mv.value} ${confidencePip(mv.confidence)}</span>`
    : `<span style="font-size:11px;color:#c8bfb0;font-family:monospace">mkt val unavailable</span>`;

  const sourceHtml = mv?.source ? `<div class="card-source">ğŸ“Š ${mv.source}</div>` : "";

  return `<a class="${classes}" href="${a.url}" target="_blank" style="animation-delay:${rank*0.06}s">
    <div class="card-inner">
      <div class="card-rank">#${rank}</div>
      <div class="card-body">
        <div class="card-badges">
          ${isHot?'<span class="badge hot-buy">HOT BUY</span>':""}
          ${snipeBadge(a.timeLeft)}
          ${dealBadge(a.price, mv?.value||null)}
        </div>
        <div class="card-title">${a.title}</div>
        <div class="card-prices">
          <span class="card-price ${isHot?"hot":""}">Â£${a.price.toFixed(2)}</span>
          ${mvHtml}
          <span class="card-sep">Â·</span>
          <span class="card-bids">${a.bids===0?"no bids":`${a.bids} bid${a.bids!==1?"s":""}`}</span>
          <span class="card-time ${isUrgent?"urgent":""}">â± ${a.timeLeft}</span>
        </div>
        ${sourceHtml}
      </div>
      <div class="card-arrow">â†’</div>
    </div>
  </a>`;
}

function renderListings() {
  const el = document.getElementById("listings");
  if (!currentAuctions.length) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ”</div><p>No auctions match your filters</p><small>Try raising the price ceiling or turning off snipe mode</small></div>`;
    return;
  }
  el.innerHTML = currentAuctions.map((a,i) => renderCard(a, i+1, currentMV[a.id]===undefined?null:currentMV[a.id], currentMV[a.id]===undefined)).join("");

  // Update stats
  const hotCount = currentAuctions.filter(a=>scoreWatch(a.title,a.price,a.bids,currentMV[a.id]?.value||null)>=7).length;
  document.getElementById("statCount").textContent = currentAuctions.length;
  document.getElementById("statHot").textContent = hotCount;
  document.getElementById("statLowest").textContent = `Â£${Math.min(...currentAuctions.map(a=>a.price)).toFixed(2)}`;
  document.getElementById("stats").style.display = "flex";
  document.getElementById("footer").style.display = "block";
  document.getElementById("ctaLink").href = `https://www.ebay.co.uk/sch/i.html?_nkw=${encodeURIComponent(SEARCHES[activeTab].query)}&LH_Auction=1&LH_PrefLoc=1${priceEnabled?`&_udhi=${maxPrice}`:""}`;
}

// â”€â”€ Main fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doFetch(silent = false) {
  if (!silent) {
    document.getElementById("listings").innerHTML = [1,2,3,4].map((_,i)=>`<div class="skeleton" style="opacity:${0.65-i*0.1};animation:shimmerIn 0.3s ease ${i*0.07}s both"></div>`).join("");
    document.getElementById("stats").style.display = "none";
    document.getElementById("aiBox").style.display = "none";
    document.getElementById("footer").style.display = "none";
    document.getElementById("apiBanner").innerHTML = "";
    currentMV = {};
    currentAuctions = [];
  }

  const dot = document.getElementById("statusDot");
  const txt = document.getElementById("statusText");
  dot.className = "status-dot loading";
  txt.textContent = "fetching auctionsâ€¦";

  const query = SEARCHES[activeTab].query;
  let results = [], usedFallback = false;

  try {
    results = await fetchListings(query, priceEnabled ? maxPrice : null);
    if (!results.length) throw new Error("No auction results for this search");
    document.getElementById("apiBanner").innerHTML = `<div class="banner live">âœ“ Live eBay UK data Â· Production</div>`;
    dot.className = "status-dot live";
    txt.textContent = "ebay uk Â· live";
  } catch(err) {
    usedFallback = true;
    document.getElementById("apiBanner").innerHTML = `<div class="banner fallback">âš  ${err.message}</div>`;
    dot.className = "status-dot fallback";
    txt.textContent = "ebay.co.uk Â· demo data";
  }

  document.getElementById("statusTime").textContent = new Date().toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"});

  if (snipeMode) results = results.filter(a => parseMins(a.timeLeft) <= 120);
  results = results
    .map(a => ({...a, score: scoreWatch(a.title,a.price,a.bids,null)}))
    .sort((a,b) => snipeMode ? parseMins(a.timeLeft)-parseMins(b.timeLeft) : b.score-a.score)
    .slice(0, 7);

  currentAuctions = results;
  // Mark all MV as loading
  results.forEach(a => { currentMV[a.id] = undefined; });
  renderListings();

  // Fetch market values in parallel, update cards as they come in
  const mvPromises = results.map(async a => {
    const mv = await fetchMarketValue(a.title);
    currentMV[a.id] = mv || null;
    renderListings();
    return { id: a.id, mv };
  });

  const resolved = await Promise.all(mvPromises);
  const mvMap = {};
  resolved.forEach(({id, mv}) => { mvMap[id] = mv; });
  checkNotifications(results, mvMap);
  fetchAiSummary(results, mvMap);
}

async function fetchAiSummary(results, mvMap) {
  if (!results.length) return;
  const aiBox = document.getElementById("aiBox");
  const aiContent = document.getElementById("aiContent");
  aiBox.style.display = "block";
  aiContent.innerHTML = `<div class="ai-loading"><div class="ai-spinner"></div><span class="ai-loading-text">Analysing with live market dataâ€¦</span></div>`;

  try {
    const listText = results.slice(0,5).map((a,i) => {
      const mv = mvMap[a.id];
      return `${i+1}. "${a.title}" â€” Â£${a.price.toFixed(2)}, ${mv?`est. market Â£${mv.value} (${mv.confidence})`:"market value unknown"}, ${a.bids} bids, ${a.timeLeft} left`;
    }).join("\n");

    const res = await fetch("https://api.anthropic.com/v1/messages", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({
        model:"claude-sonnet-4-20250514", max_tokens:1000,
        system:"You are a vintage watch expert and deal hunter specialising in the UK eBay marketplace. Give a sharp, opinionated 2â€“3 sentence take on which listings look like the best buys, referencing the live market values. Use collector lingo naturally. No bullet points.",
        messages:[{role:"user",content:`Analyse these UK eBay auction listings:\n\n${listText}`}]
      })
    });
    const data = await res.json();
    const text = data?.content?.[0]?.text || "";
    aiContent.innerHTML = `<p class="ai-text">${text}</p>`;
  } catch {
    aiContent.innerHTML = `<p class="ai-text" style="color:#c8bfb0">Couldn't load analysis.</p>`;
  }
}

// â”€â”€ Countdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startCountdown() {
  if (countdownTimer) clearInterval(countdownTimer);
  countdown = REFRESH_INTERVAL;
  countdownTimer = setInterval(() => {
    countdown--;
    const pct = (countdown / REFRESH_INTERVAL) * 100;
    const m = Math.floor(countdown/60), s = countdown%60;
    document.getElementById("countdownTime").textContent = `${m}:${s.toString().padStart(2,"0")}`;
    document.getElementById("countdownFill").style.width = `${pct}%`;
    if (countdown <= 0) {
      countdown = REFRESH_INTERVAL;
      doFetch(true);
    }
  }, 1000);
}

// â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(i) {
  activeTab = i;
  document.querySelectorAll(".tab").forEach((t,j) => t.className = "tab" + (j===i?" active":""));
  startCountdown();
  doFetch();
}

function toggleSnipe() {
  snipeMode = !snipeMode;
  const btn = document.getElementById("snipeBtn");
  btn.className = "pill" + (snipeMode?" active":"");
  btn.textContent = `âš¡ Snipe mode ${snipeMode?"ON":"OFF"}`;
  doFetch();
}

function togglePrice() {
  priceEnabled = !priceEnabled;
  const btn = document.getElementById("priceBtn");
  btn.className = "pill" + (priceEnabled?" price-active":"");
  btn.textContent = priceEnabled ? `Â£ â‰¤ Â£${maxPrice}` : "Â£ Price cap";
  document.getElementById("sliderWrap").style.display = priceEnabled ? "block" : "none";
  doFetch();
}

function updateSlider(v) {
  maxPrice = parseInt(v);
  document.getElementById("sliderVal").textContent = `Â£${maxPrice}`;
  document.getElementById("priceBtn").textContent = `Â£ â‰¤ Â£${maxPrice}`;
  // Update slider gradient
  const pct = ((maxPrice-5)/495)*100;
  document.getElementById("priceSlider").style.background = `linear-gradient(90deg,#d97706 ${pct}%,#e8e2d8 ${pct}%)`;
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initNotifications();
startCountdown();
doFetch();
</script>

</body>
</html>
